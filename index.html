<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Three.js GLB Viewer — Dog-Ear Import</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { height: 100%; margin: 0; background: #000; color: #fff; }
    #app { position: fixed; inset: 0; }

    /* Pulse animation (scales from the corner) */
    @keyframes dogear-pulse {
      0%   { transform: scale(1);   box-shadow: 0 0 0 rgba(255,105,180,0.0); }
      50%  { transform: scale(1.12); box-shadow: 0 0 16px rgba(255,105,180,0.35); }
      100% { transform: scale(1);   box-shadow: 0 0 0 rgba(255,105,180,0.0); }
    }

    /* Dog-ear — 200% larger vs original 32px (now 96x96), hot pink, opaque, pulsing */
    #dogear {
      position: fixed; right: 0; bottom: 0; width: 96px; height: 96px;
      clip-path: polygon(100% 0, 0 100%, 100% 100%);
      background: #ff69b4;
      border-left: 1px solid #ff69b4;
      border-top: 1px solid #ff69b4;
      z-index: 10; cursor: pointer;
      transform-origin: 100% 100%;
      animation: dogear-pulse 1.5s ease-in-out infinite;
      transition: filter .2s ease;
    }
    #dogear:hover,
    #dogear.active { filter: brightness(1.15); }

    /* Tooltip on hover */
    #dogear::after {
      content: "drop glb here";
      position: absolute; right: 106px; bottom: 14px;
      padding: 4px 8px; font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: rgba(20,20,20,.85); border: 1px solid #333; border-radius: 8px; color: #ffd9ef;
      opacity: 0; pointer-events: none; transition: opacity .15s ease; white-space: nowrap;
    }
    #dogear:hover::after { opacity: 1; }

    @media (prefers-reduced-motion: reduce) {
      #dogear { animation: none; }
    }

    /* Optional tiny hint (bottom-left) */
    #hint { position: fixed; left: 10px; bottom: 10px; opacity: .7; font: 12px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
  </style>

  <!-- Import map so "three" resolves as an ES module -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
    }
  }
  </script>
</head>
<body>
  <div id="app"></div>

  <!-- Dog-ear import UI -->
  <div id="dogear" title="Click or drop a .glb here"></div>
  <input id="file" type="file" hidden accept=".glb,.gltf,model/gltf-binary,model/gltf+json" />
  <div id="hint">drag/drop onto corner • click to browse</div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';

    // ---- renderer / scene / camera ----
    const app = document.getElementById('app');
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x000000, 1);
    app.appendChild(renderer.domElement);

    const scene  = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.01, 2000);
    camera.position.set(0, 0, 6);

    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const dir = new THREE.DirectionalLight(0xffffff, 0.6); dir.position.set(5,5,5); scene.add(dir);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enablePan = false;

    // Root we rotate
    const root = new THREE.Group(); scene.add(root);

    // ---- loader / material ----
    const loader = new GLTFLoader();
    const wireMat = new THREE.MeshBasicMaterial({ color: 0x22c55e, wireframe: true });

    function applyGreenWireframe(object3d) {
      object3d.traverse((child) => {
        if (child.isMesh || child.isSkinnedMesh) {
          if (Array.isArray(child.material)) child.material.forEach(m => m.dispose?.());
          else child.material?.dispose?.();
          child.material = wireMat;
          child.castShadow = false;
          child.receiveShadow = false;
        }
      });
    }

    function clearRoot() {
      while (root.children.length) {
        const c = root.children.pop();
        c.traverse?.(obj => {
          if (obj.geometry) obj.geometry.dispose?.();
          if (obj.material && obj.material !== wireMat) {
            if (Array.isArray(obj.material)) obj.material.forEach(m => m.dispose?.());
            else obj.material.dispose?.();
          }
        });
        c.removeFromParent?.();
      }
    }

    // Downscale-only center & fit
    function centerAndFit(object3d, targetSize = 3.2, downscaleOnly = true) {
      object3d.updateMatrixWorld(true);
      const box = new THREE.Box3().setFromObject(object3d);
      const size = new THREE.Vector3(), center = new THREE.Vector3();
      box.getSize(size); box.getCenter(center);

      object3d.position.sub(center);
      const maxDim = Math.max(size.x, size.y, size.z) || 1;
      let s = targetSize / maxDim;
      if (downscaleOnly && s > 1) s = 1;
      object3d.scale.setScalar(s);

      object3d.updateMatrixWorld(true);
      const box2 = new THREE.Box3().setFromObject(object3d);
      const center2 = new THREE.Vector3(); box2.getCenter(center2);
      object3d.position.sub(center2);
    }

    async function showGLBFromURL(url) {
      const gltf = await loader.loadAsync(url);
      const obj = gltf.scene || gltf.scenes?.[0];
      obj.rotation.set(0,0,0); obj.position.set(0,0,0); obj.updateMatrixWorld(true);

      clearRoot();
      applyGreenWireframe(obj);
      centerAndFit(obj, 3.2, true);
      root.add(obj);
    }

    // ---- render loop ----
    const clock = new THREE.Clock();
    function animate() {
      requestAnimationFrame(animate);
      const dt = clock.getDelta();
      root.rotation.y += 0.2 * dt; // slow continuous rotation
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
      const w = window.innerWidth, h = window.innerHeight;
      camera.aspect = w / h; camera.updateProjectionMatrix(); renderer.setSize(w, h);
    });

    // ---- dog-ear file input & dropzone ----
    const dogear = document.getElementById('dogear');
    const fileEl = document.getElementById('file');

    dogear.addEventListener('click', () => fileEl.click());

    ['dragenter','dragover'].forEach(evt => {
      dogear.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation(); dogear.classList.add('active');
      }, false);
    });
    ['dragleave','drop'].forEach(evt => {
      dogear.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation(); dogear.classList.remove('active');
      }, false);
    });
    dogear.addEventListener('drop', async (e) => {
      const file = e.dataTransfer?.files?.[0];
      if (!file) return;
      try {
        const url = URL.createObjectURL(file);
        await showGLBFromURL(url);
      } catch (err) {
        console.error(err); alert('Failed to load file. See console for details.');
      }
    });

    fileEl.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      try {
        const url = URL.createObjectURL(file);
        await showGLBFromURL(url);
      } catch (err) {
        console.error(err); alert('Failed to load file. See console for details.');
      } finally {
        fileEl.value = '';
      }
    });
  </script>
</body>
</html>
